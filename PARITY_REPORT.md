# Civ7 Modding Tools - Parity Report

**Date**: January 18, 2026  
**Status**: ❌ **PARITY ISSUES DETECTED**  
**Test Case**: Gondor Civilization Example  
**Baseline**: TypeScript v1.3.0 (dist-ts-reference)  
**Candidate**: Python 2.0.0-py (dist-py-candidate)  

---

## Executive Summary

The Python implementation does NOT achieve 100% parity with the TypeScript reference implementation. While the overall structure and builder pattern are ported correctly, there are **significant differences** in:

1. **File structure** - Path generation differences (kebab-case handling)
2. **File generation** - Missing `game-effects.xml` files from certain builders
3. **ModInfo generation** - Structural and naming inconsistencies
4. **XML formatting** - XML declaration encoding differs
5. **Action groups** - Different grouping and scoping strategy

**Impact**: Generated mods may not function identically to TypeScript output.

---

## Detailed Findings

### 1. File Structure Differences

#### Issue 1.1: Path Generation - Kebab-Case Inconsistency

**Problem**: Constructible path generation differs between TS and PY

| Entity | TypeScript Path | Python Path | Issue |
|--------|-----------------|-------------|-------|
| `BUILDING_GONDOR2` | `constructibles/gondor-2/` | `constructibles/gondor2/` | Missing dash in kebab-case conversion |

**Root Cause**: The Python `kebab_case()` utility appears to not convert `GONDOR2` to `gondor-2`. This suggests the utility function is not properly handling uppercase sequences followed by numbers.

**Evidence**:
- TS generates: `constructibles/gondor-2/` ✓
- PY generates: `constructibles/gondor2/` ✗

**File Count Impact**: 3 files (always.xml, icons.xml, localization.xml) missing from Python output under wrong path.

#### Issue 1.2: Quarter-Gondor Path Numbering

Expected consistent path generation for unique quarters. Python implementation needs verification.

---

### 2. Missing XML Files

#### Issue 2.1: Missing `game-effects.xml` in Quarter-Gondor

**TypeScript Output**:
```
constructibles/quarter-gondor/game-effects.xml ✓
```

**Python Output**:
```
constructibles/quarter-gondor/game-effects.xml ✗ (MISSING)
```

**Root Cause**: The Python `UniqueQuarterBuilder` does not generate `game-effects.xml` when modifiers are bound. The builder filters out files where `content is None`.

**Expected Behavior** (from TypeScript):
```typescript
new XmlFile({
    path,
    name: 'game-effects.xml',
    content: this._gameEffects.toXmlElement(),
    actionGroups: [this.actionGroupBundle.always],
    actionGroupActions: [ACTION_GROUP_ACTION.UPDATE_DATABASE]
})
```

**Python Implementation**: Not generating game-effects file even though modifiers are bound via `.bind()`.

#### Issue 2.2: Missing `game-effects.xml` in Civics-Gondor (ProgressionTree)

**TypeScript Output**:
```
progression-trees/civics-gondor/game-effects.xml ✓
```

**Python Output**:
```
progression-trees/civics-gondor/game-effects.xml ✗ (MISSING)
```

**Root Cause**: The Python `ProgressionTreeBuilder` appears to not generate the `game-effects.xml` file for progression tree modifiers.

---

### 3. ModInfo Generation Differences

#### Issue 3.1: XML Declaration Encoding

**TypeScript**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
```

**Python**:
```xml
<?xml version="1.0" encoding="utf-8"?>
```

**Impact**: Minor - semantically equivalent but inconsistent encoding case.

#### Issue 3.2: ModInfo Properties

**TypeScript** includes:
```xml
<Name>test</Name>
<Description>generated by https://github.com/izica/civ7-modding-tool</Description>
<Authors>generated by https://github.com/izica/civ7-modding-tool</Authors>
```

**Python** includes:
```xml
<Name>My Mod</Name>
<Version>1</Version>
<AffectsSavedGames>1</AffectsSavedGames>
```

**Analysis**: Python is missing Description and Authors metadata.

#### Issue 3.3: ActionCriteria Naming

**TypeScript**:
```xml
<Criteria id="antiquity-age-current">
<Criteria id="always">
```

**Python**:
```xml
<Criteria id="CRITERIA_AGE_ANTIQUITY">
<Criteria id="CRITERIA_ALWAYS">
<Criteria id="CRITERIA_SHELL_...">
```

**Impact**: Different naming convention (kebab-case vs UPPER_SNAKE_CASE with CRITERIA_ prefix). Python adds an extra shell criteria.

#### Issue 3.4: ActionGroup Scoping

**TypeScript** structure:
- `age-antiquity-current` (game scope, age criteria)
- `eb2361d6-...` (game scope, always criteria)
- `ea02e935-...` (shell scope, always criteria)

**Python** structure:
- `CURRENT_AGE_ANTIQUITY` (game scope, age criteria)
- `ALWAYS_AGE_ANTIQUITY` (game scope, always criteria)
- `SHELL_AGE_ANTIQUITY` (shell scope, age criteria)
- `ALWAYS` (game scope, always criteria)

**Analysis**: Python organizes action groups differently by action_group_bundle and scopes, while TypeScript uses a flatter structure with UUIDs for grouping.

#### Issue 3.5: File Actions Organization

**TypeScript**:
```xml
<ActionGroup id="age-antiquity-current">
    <UpdateDatabase>
        <Item>civilizations/gondor/current.xml</Item>
        <Item>civilizations/gondor/game-effects.xml</Item>
        ...
    </UpdateDatabase>
    <UpdateVisualRemaps>
        <Item>units/gondor-scout/visual-remap.xml</Item>
    </UpdateVisualRemaps>
    <UpdateIcons>...</UpdateIcons>
</ActionGroup>
```

**Python**:
```xml
<ActionGroup id="CURRENT_AGE_ANTIQUITY">
    <UpdateDatabase>
        <Item>civilizations/gondor/current.xml</Item>
        <Item>civilizations/gondor/game-effects.xml</Item>
        ...
        <Item>units/gondor-scout/visual-remap.xml</Item>
        ...
    </UpdateDatabase>
</ActionGroup>
```

**Analysis**: Python mixes file types (UpdateVisualRemaps, UpdateIcons) into UpdateDatabase. This is incorrect.

---

### 4. XML Content Differences

#### Issue 4.1: Civilization Current.xml - Element Ordering

**TypeScript**:
```xml
<Civilizations>
    ...
</Civilizations>
<TraitModifiers>
    ...
</TraitModifiers>
```

**Python**:
```xml
<Civilizations>
    ...
</Civilizations>
<Civilizations>  <!-- DUPLICATE? -->
    ...
</Civilizations>
```

**Root Cause**: The Python `CivilizationNode` serialization appears to have structural issues. Requires debugging the `migrate()` method in `CivilizationBuilder`.

#### Issue 4.2: Icon Definition Attributes

**TypeScript** (icons.xml):
```xml
<Row Id="CIVILIZATION_GONDOR" Path="fs://game/mod-test/civ_sym_gondor"/>
```

**Python** (icons.xml):
```xml
<Row Id="CIVILIZATION_GONDOR" Path="fs://game/mod-test/civ_sym_gondor"/>
<!-- appears identical but possibly different in XML generation context -->
```

---

## File Summary

### TypeScript (dist-ts-reference): 26 files
```
mod-test.modinfo
civilizations/gondor/
  ├── current.xml
  ├── legacy.xml
  ├── shell.xml
  ├── icons.xml
  ├── localization.xml
  └── game-effects.xml ✓

units/gondor-scout/
  ├── current.xml
  ├── visual-remap.xml
  ├── localization.xml
  └── icons.xml

constructibles/gondor/
  ├── always.xml
  ├── icons.xml
  └── localization.xml

constructibles/gondor-2/
  ├── always.xml
  ├── icons.xml
  └── localization.xml

constructibles/quarter-gondor/
  ├── always.xml
  ├── icons.xml
  ├── game-effects.xml ✓
  └── localization.xml

progression-trees/civics-gondor/
  ├── current.xml
  ├── game-effects.xml ✓
  └── localization.xml

imports/
  ├── civ_sym_gondor
  └── scout.png
```

### Python (dist-py-candidate): 24 files
```
mod-test.modinfo
civilizations/gondor/
  ├── current.xml
  ├── legacy.xml
  ├── shell.xml
  ├── icons.xml
  ├── localization.xml
  └── game-effects.xml ✓

units/gondor-scout/
  ├── current.xml
  ├── visual-remap.xml
  ├── localization.xml
  └── icons.xml

constructibles/gondor/
  ├── always.xml
  ├── icons.xml
  └── localization.xml

constructibles/gondor2/  ← WRONG PATH (should be gondor-2)
  ├── always.xml
  ├── icons.xml
  └── localization.xml

constructibles/quarter-gondor/
  ├── always.xml
  ├── icons.xml
  └── localization.xml   ← MISSING game-effects.xml

progression-trees/civics-gondor/
  ├── current.xml
  └── localization.xml   ← MISSING game-effects.xml

imports/
  ├── civ_sym_gondor
  └── scout.png
```

---

## Critical Issues (Blocking Parity)

### P0 - Path Generation Bug

**Issue**: `BUILDING_GONDOR2` → `gondor2` instead of `gondor-2`

**Impact**: Mod will have broken directory structure

**Action Required**:
1. Debug `kebab_case()` utility function
2. Ensure it properly handles uppercase sequences followed by numbers
3. Add test case: `kebab_case("BUILDING_GONDOR2")` should return `"building_gondor2"` (after trim)

---

### P1 - Missing Game-Effects Files

**Issue**: `UniqueQuarterBuilder` and `ProgressionTreeBuilder` don't generate `game-effects.xml`

**Impact**: Game modifiers won't be applied correctly

**Action Required**:
1. Check `UniqueQuarterBuilder.migrate()` - ensure `_game_effects` is populated
2. Check `ProgressionTreeBuilder.migrate()` - ensure `_game_effects` is populated
3. Ensure `.build()` methods don't filter out game-effects files

---

### P2 - ModInfo ActionGroup Organization

**Issue**: File type actions (UpdateVisualRemaps, UpdateIcons) are merged into UpdateDatabase

**Impact**: Mods may not load visual remaps and icons correctly

**Action Required**:
1. Investigate `Mod.build()` implementation
2. Ensure file actions are grouped by type (UpdateDatabase, UpdateVisualRemaps, UpdateIcons, UpdateText)
3. Add grouping logic similar to TypeScript

---

## Minor Issues (Polish)

- XML declaration encoding case (UTF-8 vs utf-8)
- ModInfo metadata (Description, Authors)
- ActionCriteria naming convention consistency

---

## Recommendations

1. **Immediate**: Fix path generation for entities with numeric suffixes
2. **High Priority**: Fix missing game-effects.xml generation
3. **High Priority**: Fix ActionGroup file action organization
4. **Medium**: Align ModInfo generation and XML encoding

---

## Next Steps

1. Review and fix identified issues in Python implementation
2. Re-run parity check
3. Establish parity test as part of CI/CD pipeline
4. Consider snapshot testing against TypeScript output

---

## Appendix: Testing Method

```bash
# Build TypeScript reference
npm run build

# Copy output
cp -r example-generated-mod dist-ts-reference

# Build Python candidate
uv run python examples/gondor_civilization.py

# Run parity check
uv run python parity_checker.py
```

---

**Report Generated**: 2026-01-18 by Parity Checker v1.0
